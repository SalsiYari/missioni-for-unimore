<h3>Pasti:</h3>
<form id="pastiForm" action="{% url 'RimborsiApp:salva_pasti' id=missione.id %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ pasti_formset.management_form }}
    <div id="pasti-formset-container">
        {% for form in pasti_formset.forms %}
            <div class="card-lg-inline mb-5 mb-md-3 pasti_formset_row dynamic-formset1 text-black d-lg-flex align-items-end"
                 style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                {% for field in form.visible_fields %}
                    <div class="form-group mx-1">
                        {% if forloop.first %}
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        {% endif %}
                        {% if field.name == 'img_scontrino1' or field.name == 'img_scontrino2' or field.name == 'img_scontrino3' %}
                            {{ field }}
                        {% else %}
                            <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                            {{ field.errors.as_ul }}
                            {{ field }}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    <div class="text-left-custom" style="text-align: right">
        <input class="btn btn-primary" type="submit" value="Salva">
    </div>
</form>

<script>
    function sendDataToServer() {
        let dataToSend = {};
        
        // Itera su tutti i campi del formset per raccogliere i dati
        document.querySelectorAll('#pasti-formset-container input, #pasti-formset-container select, #pasti-formset-container textarea').forEach(field => {
            dataToSend[field.name] = field.value || "";  // Aggiunge il valore del campo al payload
        });

        // Prepara i dati da inviare tramite FormData
        let formData = new FormData();
        formData.append('data', JSON.stringify(dataToSend));
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}'); // Token CSRF necessario per Django

        // Invia i dati con fetch tramite POST
        fetch("{% url 'RimborsiApp:salva_pasti' id=missione.id %}", {
            method: 'POST',
            body: formData
        }).then(response => {
            if (!response.ok) {
                console.error("Errore nella richiesta:", response.statusText);
            } else {
                console.log("Dati inviati correttamente!");
            }
        });
    }

    let debounceTimer; // Timer per debounce
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Aggiunge listener su tutti i campi all'interno del formset
        document.querySelectorAll('#pasti-formset-container input, #pasti-formset-container select, #pasti-formset-container textarea').forEach(field => {
            field.addEventListener('input', () => {
                debounce(() => sendDataToServer(), 2000); // Debounce di 2 secondi
            });
        });
    });
</script>
