{% extends "Rimborsi/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% block title %}Profilo{% endblock %}

{% block content %}
    {% spaceless %}

        <h2>Dati anagrafici:
            <a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Profilo Straniero"
               data-content="Gli utenti nati in un paese estero possono creare un profilo speciale cliccando
                pulsante 'Profilo Straniero'."><i
            class="fa fa-info-circle fa-1x" aria-hidden="true"></i></a>
            <a id="profilo_straniero" style="width: 120px; margin-top: 8px" class='btn btn-sm btn-info' href="{% url 'RimborsiApp:foreign_profile'%}">Profilo Straniero</a>
        </h2>

        <style>
            @media screen and (max-width: 450px){
                #profilo_straniero { float: none; display: block; }
            }
            @media screen and (min-width: 450px) {
                #profilo_straniero { float: right; display: inline-block;
                }
            }
        </style>

        <div class="rounded">
            <br>
            {% crispy profile_form %}
        </div>
        <hr>

        <h2>Automobili:</h2>
        <form action="{% url 'RimborsiApp:automobili' %}" method="post">{% csrf_token %}
            <table class="table table-striped table-md">
                {{ automobili_formset.management_form }}
                {% for form in automobili_formset.forms %}
                    {% if forloop.first %}
                        <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                                <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                    {% endif %}
                    <tr class="{% cycle 'row1' 'row2' %} formset_row">
                        {% for field in form.visible_fields %}
                            <td>
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <input class="btn btn-primary" style="margin-bottom: 50px" type="submit" value="Aggiorna">

        </form>
        
        
        <h2 style="display: flex; align-items: center;">
            Gestione Firme:
            <a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Carica Firma"
               data-content="è possibile caricare l'immagine della propria firma compilando il seguente form.">
               <i class="fa fa-info-circle fa-1x" aria-hidden="true" style="margin-left: 10px; "></i>
            </a>
        </h2>
        
        <form action="{% url 'RimborsiApp:firma' %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            <table class="table table-striped table-md">
                {{ firme_formset.management_form }}
                {% for form in firme_formset.forms %}
                    {% if forloop.first %}
                        <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                                <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                    {% endif %}
                    <tr class="{% cycle 'row1' 'row2' %} formset_row">
                        {% for field in form.visible_fields %}
                            <td>
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <input class="btn btn-primary" style="margin-bottom: 50px" type="submit" value="Aggiorna">

        </form>
        
        
         <h3 style="display: flex; align-items: center;">
            Condividi firma:
            <a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Carica Firma"
               data-content="è possibile condividere la propria firma con un utente attraverso '.">
               <i class="fa fa-info-circle fa-1x" aria-hidden="true" style="margin-left: 10px; "></i>
            </a>
        </h3>
        
        <div style=" padding-left: 75px ; padding-right: 75px ; background-color: #f3f3f3 ; height: 65px ; padding-top: 12px ; padding-bottom: 10px">
            <form method="POST" enctype="multipart/form-data" action="{% url 'RimborsiApp:firma_shared' %}">
                <span style="display: flex; justify-content: space-between; align-items: center ; ">
                    {% csrf_token %}
                    <h5>{{ firme_shared.firma.label }} </h5>
                    <div style="max-width: 2500px">
                        {{ firme_shared.firma }}
                    </div>
                    <h5 style="padding-left: 20px"> {{ firme_shared.user_guest.label }}</h5>
                    <div style="max-width: 3000px ;">
                        {{ firme_shared.user_guest }}
                    </div>
                    <button class="btn btn-success" type="submit" style="display: inline-flex ; align-items: flex-end ; margin-left: 50px ">Conividi la Firma</button>
                </span>
            </form>
        </div>
        <br>
        <!-- qui il codice per visualizzare e rimuovere le firme condivise da me -->
        
        <form action="{% url 'RimborsiApp:firma_recived_visualization' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <table class="table table-striped table-md">
                {{ firme_recived_visual.management_form }}
                {% for form in firme_recived_visual.forms %}
                    {% if forloop.first %}
                        <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                                <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        
                        </tr>
                        </thead>
                    {% endif %}
                    <tr class="{% cycle 'row1' 'row2' %} formset_row">
                        {% for field in form.visible_fields %}
                            <td>
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
            <input class="btn btn-primary" style="margin-bottom: 50px" type="submit" value="Aggiorna">
        </form>
        <hr>
        <!-- firme_recived_formset -->
        <h3 style="display: flex; align-items: center;">
            Firme Condivise con Te:
            <a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Carica Firma"
               data-content="le firme di seguito sono state condivise da altri utenti per agevolare la compilazione della Modulistica  ">
               <i class="fa fa-info-circle fa-1x" aria-hidden="true" style="margin-left: 10px; "></i>
            </a>
        </h3>
        
        <form enctype="multipart/form-data">
            {% csrf_token %}
            <table class="table table-striped table-md">
                {{ firme_recived_formset.management_form }}
                {% for form in firme_recived_formset.forms %}
                    {%  if forloop.first %}
                        <thead>
                        <tr class="display-row">
                            <td style="font-family: 'Apple Symbols' "> <h4> l'utente :</h4></td>
                            <td style="font-family: 'Apple Symbols' "> <h4>  ha condiviso la firma :</h4></td>
                            <td style="font-family: 'Apple Symbols' "> <h4>  con la seguente descrizione :</h4></td>
                        </tr>
                        </thead>
                    {% endif %}
                    <tr class="{% cycle 'row1' 'row2' %} display-row">
                        {% for field in form.visible_fields %}
                            <td>
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                
                                {% if field.name == 'user_owner' %}
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                {% elif field.name == 'desc_firma' %}
                                    {{ field.errors.as_ul }}
                                    {{ field }}     
                                {% endif %}
                                {% if field.name == 'firma' %}
                                    
                                    {% if form.instance.firma.img_firma %}
                                        <img src="{{ form.instance.firma.img_firma.url }}" alt="Firma immagine" style="max-width: 200px; max-height: 70px;" />
                                    {% endif %}
                                {%endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
        </form>
        

        
       <style>
            .display-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-right: 90px;
                padding-left: 90px;
            }</style>

        <script src="{% static 'RimborsiApp/formset/jquery_formset.js' %}"></script>
        <script type="text/javascript">
            
            $('.formset_row').formset({
                addText: 'Aggiungi',
                deleteText: 'Elimina',
                prefix: 'automobile_set'
            });

            if ($('#id_qualifica').val() !== 'DOTTORANDO') {
                $('#dottorando-details').hide();
            }

            $('#id_qualifica').change(function () {
                if ($(this).val() == 'DOTTORANDO') {
                    $('#dottorando-details').show();
                } else {
                    $('#dottorando-details').hide();
                }
            });
            $('#domicilio-fieldset legend').append(" <input type='button' name='copy-domicilio' value='Copia da residenza' class='btn btn-sm btn-info' id='button-id-copy-domicilio'>")

            $('#button-id-copy-domicilio').click(function () {
                let values = $();
                $('#residenza-row :input[type=text]').each(function () {
                    values.push($(this).val());
                });
                $('#domicilio-row :input[type=text]').each(function (index) {
                    $(this).val(values[index]);
                });
                let residenza_comune = $('#select2-id_residenza_comune-container');
                let domicilio_comune = $('#select2-id_domicilio_comune-container');
                let residenza_provincia = $('#select2-id_residenza_provincia-container');
                let domicilio_provincia = $('#select2-id_domicilio_provincia-container');
                $(domicilio_comune).prop('title', $(residenza_comune).prop('title'));
                $(domicilio_provincia).prop('title', $(residenza_provincia).prop('title'));

                $('#id_domicilio_comune').empty();
                $('#id_domicilio_provincia').empty();
                $('#select2-id_residenza_comune-container span').clone().appendTo($('#select2-id_domicilio_comune-container'));
                $('#select2-id_residenza_provincia-container span').clone().appendTo($('#select2-id_domicilio_provincia-container'));
                $('#id_residenza_comune option').each(function () {
                    if ($(this).prop('selected') === true) {
                        $(this).clone().appendTo($('#id_domicilio_comune'));
                    }
                });
                $('#id_residenza_provincia option').each(function () {
                    if ($(this).prop('selected') === true) {
                        $(this).clone().appendTo($('#id_domicilio_provincia'));
                    }
                });
            });

            $('.popover-dismiss').popover({
                trigger: 'focus'
            });
            
            $('img').mousedown(function (e) {               //way to save image downloading
              if(e.button == 2) {                           // right click
                return false;                               // do nothing!
              }
            });
        </script>
        <style>
            .select2-container, .select2-container .select2-selection--single {
                min-width: 0 !important;
                min-height: 0 !important;
                width: 100% !important;
                height: 38px !important;
            }
        </style>
    {% endspaceless %}
{% endblock %}