{% comment %}
#TODO   utilizzato per comparare  e backup di script in MISISONI.HTML 
{% endcomment %}


    {% comment%}
    {% endcomment%}
      <script>
        let debounceTimer;
        const debounceDelayFormset1 = 5000;  // Delay per "pernottamenti"
        const debounceDelayFormset2 = 5000;  // Delay per "pasti"
        const debounceDelayFormset3 = 5000;  // Delay per "trasporti"
        const debounceDelayFormset4 = 5000;  // Delay per "convegni"
        const debounceDelayFormset5 = 5000;  // Delay per "altrespese"
    
        // Funzione debounce per evitare troppi invii ravvicinati
        function debounce(callback, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(callback, delay);
        }
    
        // Funzione per monitorare i campi di un formset e inviare dati al server
        function monitorFields(row, formType) {
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                field.setAttribute('data-modified', "False");
    
                field.addEventListener('input', function () {
                    this.setAttribute('data-modified', "True");
                    const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                                  formType === 'pasti' ? debounceDelayFormset2 :
                                  formType === 'trasporti' ? debounceDelayFormset3 :
                                  formType === 'convegni' ? debounceDelayFormset4 :
                                  debounceDelayFormset5;  // per altrespese
                    debounce(() => sendDataToServer(formType), delay);
                });
            });
        }
    
        function sendDataToServer(formType) {
            {
                let dataToSend = [];
                document.querySelectorAll('.pernottamenti_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati pernottamenti salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
    
            } {
                let dataToSend = [];
                document.querySelectorAll('.altrespese_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_altrespese' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati altrespese salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
    
            } {
    // Gestione trasporti
    let dataToSend = [];
    document.querySelectorAll('.trasporti_formset_row').forEach(function (row) {
        let formFields = {};
        let formModified = false;

        // Raccogliere i campi modificati
        row.querySelectorAll('.form-group input, .form-group textarea').forEach(function (field) {
            if (field.getAttribute('data-modified') === "True") {
                formFields[field.name] = field.value;
                formModified = true;
                field.setAttribute('data-modified', "False");
            }
        });

        // Controlla il dropdown
        const dropdown = row.querySelector('.form-group select[name$="-mezzo"]');
        if (dropdown) {
            // Se il dropdown non è stato modificato, prendi il suo valore
            if (dropdown.getAttribute('data-modified') !== "True") {
                formFields[dropdown.name] = dropdown.value; // Aggiungi il valore del dropdown
            }
        }

        // Controllo per il hidden ID
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        // Aggiungi ai dati da inviare solo se ci sono campi modificati o se il dropdown è stato considerato
        if (formModified || (dropdown && dropdown.getAttribute('data-modified') !== "True")) {
            dataToSend.push(formFields);
        }
    });

    if (dataToSend.length > 0) {
        fetch("{% url 'RimborsiApp:salva_trasporti' id=missione.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: dataToSend })
        })
        .then(response => response.json())
        .then(data => console.log("Dati trasporti salvati:", data))
        .catch(error => console.error('Errore:', error));
    }
}{
                let dataToSend = [];
                document.querySelectorAll('.pasti_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_pasti' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati pasti salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
            } {
                let dataToSend = [];
                document.querySelectorAll('.convegni_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_convegni' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati convegni salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Monitora i campi per il formset "pernottamenti"
            document.querySelectorAll('.pernottamenti_formset_row').forEach(function (row) {
                monitorFields(row, 'pernottamenti');
            });
    
            // Monitora i campi per il formset "convegni"
            document.querySelectorAll('.convegni_formset_row').forEach(function (row) {
                monitorFields(row, 'convegni');
            });
    
            // Monitora i campi per il formset "altrespese"
            document.querySelectorAll('.altrespese_formset_row').forEach(function (row) {
                monitorFields(row, 'altrespese');
            });
            document.querySelectorAll('.trasporti_formset_row').forEach(function (row) {
                monitorFields(row, 'trasporti');
            });
            document.querySelectorAll('.pasti_formset_row').forEach(function (row) {
                monitorFields(row, 'pasti');
            });
            
    
            // Observer per i nuovi nodi
            const pernottamentiContainer = document.getElementById('pernottamenti-formset-container');
            const convegniContainer = document.getElementById('convegni-formset-container');
            const altrespeseContainer = document.getElementById('altrespese-formset-container');
            const pastiContainer = document.getElementById('pasti-formset-container');
            const trasportiContainer = document.getElementById('trasporti-formset-container');
    
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function (newNode) {
                            if (newNode.classList.contains('pernottamenti_formset_row')) {
                                monitorFields(newNode, 'pernottamenti');
                            }
                            if (newNode.classList.contains('convegni_formset_row')) {
                                monitorFields(newNode, 'convegni');
                            }
                            if (newNode.classList.contains('altrespese_formset_row')) {
                                monitorFields(newNode, 'altrespese');
                            }
                            if (newNode.classList.contains('pasti_formset_row')) {
                                monitorFields(newNode, 'pasti');
                            }
                            if (newNode.classList.contains('trasporti_formset_row')) {
                                monitorFields(newNode, 'trasporti');
                            }
                        });
                    }
                });
            });
    
            // Attiva l'observer per i container dei formset
            if (pernottamentiContainer) {
                observer.observe(pernottamentiContainer, { childList: true, subtree: true });
            }
            if (convegniContainer) {
                observer.observe(convegniContainer, { childList: true, subtree: true });
            }
            if (altrespeseContainer) {
                observer.observe(altrespeseContainer, { childList: true, subtree: true });
            }
            if (pastiContainer) {
                observer.observe(pastiContainer, { childList: true, subtree: true });
            }
            if (trasportiContainer) {
                observer.observe(trasportiContainer, { childList: true, subtree: true });
            }
        });
    </script>




{% comment %} 
    //script funzionante che invia tutta la riga di dat al server, non solo quelli modificati
    //problema? in nuove istanze di form mi salva tanti record per ogni campo che vado a modificare (essendo il timer istantaneo)   
{% endcomment %}   
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.setAttribute('data-modified', "False");

            field.addEventListener('blur', function () {
                this.setAttribute('data-modified', "True");
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                debounce(() => sendDataToServer(row, formType), delay);
            });
        });
    }

    // Funzione per inviare i dati al server con tutti i campi di un form
    function sendDataToServer(row, formType) {
        let formFields = {};

        // Raccoglie tutti i campi del form (non solo quelli modificati)
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            formFields[field.name] = field.value;
        });

        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: [formFields] })
        })
        .then(response => response.json())
        .then(data => console.log(`Dati ${formType} salvati:`, data))
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];
        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
    

{# script perfettamente funzionante con pasti, in questo script uso la risposta del server per aggiornare l'id del record nel formset #}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                // Invia tutti i dati del formset quando un campo viene modificato
                debounce(() => sendDataToServer(formType), delay);
            });
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
    let formsetData = [];
    
    document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
        let formFields = {};
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            formFields[field.name] = field.value;
        });
        //inserire l'id mi permette di capire se sto modificando un record esistente o sto creando un nuovo record
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        formsetData.push(formFields);
    });

    const urls = {
        pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
    };

    fetch(urls[formType], {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ data: formsetData })
    })
    .then(response => response.json())
    .then(data => {
        console.log(`Dati ${formType} salvati:`, data);

        // Aggiorna gli ID nel formset in base agli ID restituiti dal server
        data.updated_rows.forEach(updatedRow => {
            const formsetPrefix = updatedRow.formset_prefix;
            const pastoId = updatedRow.pasto_id;
            const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);    //selezioniamo il campo di input nascosto che tiene l'id del record
            if (inputIdField) {
                inputIdField.value = pastoId;
            }
        });
    })
    .catch(error => console.error('Errore:', error));
}


    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>






{% comment %} 
// funziona come precedente+ gestione di tutti i formset , problema, non gestisce le foto da usare con salva_pasti2
{% endcomment %}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>



{% comment %}
ULTIMA VERISONE SCRIPT, TENTATIVO DI GESTIORE IL CARICAMENTO DI FILE #######################################################
{% endcomment %}
{% section %}
    
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;
    const debounceDelayFormset2 = 0;
    const debounceDelayFormset3 = 0;
    const debounceDelayFormset4 = 0;
    const debounceDelayFormset5 = 0;

    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            if (field.type === "file") {
                field.addEventListener('change', function () {
                    sendFileToServer(field, formType, row);
                });
            } else {
                field.addEventListener('blur', function () {
                    const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                                  formType === 'pasti' ? debounceDelayFormset2 :
                                  formType === 'trasporti' ? debounceDelayFormset3 :
                                  formType === 'convegni' ? debounceDelayFormset4 :
                                  debounceDelayFormset5;

                    debounce(() => sendDataToServer(formType), delay);
                });
            }
        });
    }

    function sendFileToServer(field, formType, row) {
        const formData = new FormData();
        const file = field.files[0];
        formData.append(field.name, file);

        // Append additional form data (like hidden ID) for context
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formData.append(hiddenId.name, hiddenId.value);
        }

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Immagine ${formType} salvata:`, data);

            // Update ID in the formset with the server response if new ID is returned
            if (data.updated_rows) {
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    const newId = updatedRow.new_id;
                    const inputIdField = row.querySelector(`input[name="${formsetPrefix}-id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
        })
        .catch(error => console.error('Errore nel caricamento dell\'immagine:', error));
    }

    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                if (field.type !== "file") {
                    formFields[field.name] = field.value;
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Update ID fields in the formset for any newly created or updated rows
            if (data.updated_rows) {
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    const newId = updatedRow.new_id;
                    const inputIdField = document.querySelector(`input[name="${formsetPrefix}-id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
        })
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>

{% endsection %}



{% comment %} 
//suggerimento copilot gestione anche dei file: aggiunta listener per capo file e modifica di Send DataTo Server {% endcomment %}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        //let formsetData = [];
        let formsetData = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            //let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                
                if (field.type === 'file') { // Aggiungi file al FormData 
                    if (field.files.length > 0) { 
                        formsetData.append(field.name, field.files[0]); 
                    } 
                } else { 
                    formsetData.append(field.name, field.value); 
                }
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                //formFields[hiddenId.name] = hiddenId.value;
                formsetData.append(hiddenId.name, hiddenId.value);
            }

            //formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetData
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
{% comment %}
funziiona la modifica di pasti e l'inserimento di pasti nuovi, ho diviso sendDataToServer in due funzioni, una per le iiagini e una per i dati
non funziona modifica trasoirti (simile a pasti)
funzioina modifica di altrespese|convgni|pernottamenti ma non l'inserimento di nuovo record (da gestire ispirato a spese )
{% endcomment %}

<script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer2(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType) {
        let formsetDataIMG = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files.length > 0) { 
                    formsetDataIMG.append(field.name, field.files[0]); 
                } 
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>

{% comment %}
FUNZIONA: alla funzione precedente ho modificato il listener che ora è ==='change' e rimane divisa la funzione sendDataToServer in due funzioni, una per i dati e una per le immagini

PASTI: 
modifica va |inserimento va | immagini vanno | non va il pattumino del widget (perchè?) e non appare l'immagine caricata (icona blu) siccome non si riaggiorna la pagina 
TRASPORTI:

CONVEGNI+ALTRESPESE*PERNOTTAMENTI:
modifica va |inserimento non va | immagini vanno in modifica ma non ininserimento | non va il pattumino del widget (perchè?) e non appare l'immagine caricata (icona blu) siccome non si riaggiorna la pagina

{% endcomment %}

     
<script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('change', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer2(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType) {
        let formsetDataIMG = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files.length > 0) { 
                    formsetDataIMG.append(field.name, field.files[0]); 
                } 
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>


{% comment %}
funziona da dio con i pasti, la risposta ajax deve essere resa compatibile per tutti i form
{% endcomment %}

<script>

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            // Aggiungi un event listener per l'evento "change"
            field.addEventListener('change', function () {
                if (field.type === 'file') {
                    sendDataToServer2(formType,row);
                } else {
                    sendDataToServer(formType);
                }
            });
        });
    }


    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
            
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType,formRow) {
        let formsetDataIMG = new FormData();
        /*
        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files && field.files.length > 0) {
                    formsetDataIMG.append(field.name, field.files[0]);
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });
        */
         formRow.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
             if (field.files && field.files.length > 0) {
                 formsetDataIMG.append(field.name, field.files[0]);
             }
         });
         const hiddenId = formRow.querySelector('input[name$="-id"]');
         if (hiddenId) {
             formsetDataIMG.append(hiddenId.name, hiddenId.value);
         }


        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
