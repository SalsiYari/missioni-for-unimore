{% comment %}
#TODO   utilizzato per comparare  e backup di script in MISISONI.HTML 
{% endcomment %}


    {% comment%}
    {% endcomment%}
      <script>
        let debounceTimer;
        const debounceDelayFormset1 = 5000;  // Delay per "pernottamenti"
        const debounceDelayFormset2 = 5000;  // Delay per "pasti"
        const debounceDelayFormset3 = 5000;  // Delay per "trasporti"
        const debounceDelayFormset4 = 5000;  // Delay per "convegni"
        const debounceDelayFormset5 = 5000;  // Delay per "altrespese"
    
        // Funzione debounce per evitare troppi invii ravvicinati
        function debounce(callback, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(callback, delay);
        }
    
        // Funzione per monitorare i campi di un formset e inviare dati al server
        function monitorFields(row, formType) {
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                field.setAttribute('data-modified', "False");
    
                field.addEventListener('input', function () {
                    this.setAttribute('data-modified', "True");
                    const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                                  formType === 'pasti' ? debounceDelayFormset2 :
                                  formType === 'trasporti' ? debounceDelayFormset3 :
                                  formType === 'convegni' ? debounceDelayFormset4 :
                                  debounceDelayFormset5;  // per altrespese
                    debounce(() => sendDataToServer(formType), delay);
                });
            });
        }
    
        function sendDataToServer(formType) {
            {
                let dataToSend = [];
                document.querySelectorAll('.pernottamenti_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati pernottamenti salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
    
            } {
                let dataToSend = [];
                document.querySelectorAll('.altrespese_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_altrespese' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati altrespese salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
    
            } {
    // Gestione trasporti
    let dataToSend = [];
    document.querySelectorAll('.trasporti_formset_row').forEach(function (row) {
        let formFields = {};
        let formModified = false;

        // Raccogliere i campi modificati
        row.querySelectorAll('.form-group input, .form-group textarea').forEach(function (field) {
            if (field.getAttribute('data-modified') === "True") {
                formFields[field.name] = field.value;
                formModified = true;
                field.setAttribute('data-modified', "False");
            }
        });

        // Controlla il dropdown
        const dropdown = row.querySelector('.form-group select[name$="-mezzo"]');
        if (dropdown) {
            // Se il dropdown non è stato modificato, prendi il suo valore
            if (dropdown.getAttribute('data-modified') !== "True") {
                formFields[dropdown.name] = dropdown.value; // Aggiungi il valore del dropdown
            }
        }

        // Controllo per il hidden ID
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        // Aggiungi ai dati da inviare solo se ci sono campi modificati o se il dropdown è stato considerato
        if (formModified || (dropdown && dropdown.getAttribute('data-modified') !== "True")) {
            dataToSend.push(formFields);
        }
    });

    if (dataToSend.length > 0) {
        fetch("{% url 'RimborsiApp:salva_trasporti' id=missione.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: dataToSend })
        })
        .then(response => response.json())
        .then(data => console.log("Dati trasporti salvati:", data))
        .catch(error => console.error('Errore:', error));
    }
}{
                let dataToSend = [];
                document.querySelectorAll('.pasti_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_pasti' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati pasti salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
            } {
                let dataToSend = [];
                document.querySelectorAll('.convegni_formset_row').forEach(function (row) {
                    let formFields = {};
                    let formModified = false;
    
                    row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                        if (field.getAttribute('data-modified') === "True") {
                            formFields[field.name] = field.value;
                            formModified = true;
                            field.setAttribute('data-modified', "False");
                        }
                    });
    
                    if (formModified) {
                        const hiddenId = row.querySelector('input[name$="-id"]');
                        if (hiddenId) {
                            formFields[hiddenId.name] = hiddenId.value;
                        }
                        dataToSend.push(formFields);
                    }
                });
    
                if (dataToSend.length > 0) {
                    fetch("{% url 'RimborsiApp:salva_convegni' id=missione.id %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ data: dataToSend })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Dati convegni salvati:", data))
                    .catch(error => console.error('Errore:', error));
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Monitora i campi per il formset "pernottamenti"
            document.querySelectorAll('.pernottamenti_formset_row').forEach(function (row) {
                monitorFields(row, 'pernottamenti');
            });
    
            // Monitora i campi per il formset "convegni"
            document.querySelectorAll('.convegni_formset_row').forEach(function (row) {
                monitorFields(row, 'convegni');
            });
    
            // Monitora i campi per il formset "altrespese"
            document.querySelectorAll('.altrespese_formset_row').forEach(function (row) {
                monitorFields(row, 'altrespese');
            });
            document.querySelectorAll('.trasporti_formset_row').forEach(function (row) {
                monitorFields(row, 'trasporti');
            });
            document.querySelectorAll('.pasti_formset_row').forEach(function (row) {
                monitorFields(row, 'pasti');
            });
            
    
            // Observer per i nuovi nodi
            const pernottamentiContainer = document.getElementById('pernottamenti-formset-container');
            const convegniContainer = document.getElementById('convegni-formset-container');
            const altrespeseContainer = document.getElementById('altrespese-formset-container');
            const pastiContainer = document.getElementById('pasti-formset-container');
            const trasportiContainer = document.getElementById('trasporti-formset-container');
    
            const observer = new MutationObserver(function (mutations) {
                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function (newNode) {
                            if (newNode.classList.contains('pernottamenti_formset_row')) {
                                monitorFields(newNode, 'pernottamenti');
                            }
                            if (newNode.classList.contains('convegni_formset_row')) {
                                monitorFields(newNode, 'convegni');
                            }
                            if (newNode.classList.contains('altrespese_formset_row')) {
                                monitorFields(newNode, 'altrespese');
                            }
                            if (newNode.classList.contains('pasti_formset_row')) {
                                monitorFields(newNode, 'pasti');
                            }
                            if (newNode.classList.contains('trasporti_formset_row')) {
                                monitorFields(newNode, 'trasporti');
                            }
                        });
                    }
                });
            });
    
            // Attiva l'observer per i container dei formset
            if (pernottamentiContainer) {
                observer.observe(pernottamentiContainer, { childList: true, subtree: true });
            }
            if (convegniContainer) {
                observer.observe(convegniContainer, { childList: true, subtree: true });
            }
            if (altrespeseContainer) {
                observer.observe(altrespeseContainer, { childList: true, subtree: true });
            }
            if (pastiContainer) {
                observer.observe(pastiContainer, { childList: true, subtree: true });
            }
            if (trasportiContainer) {
                observer.observe(trasportiContainer, { childList: true, subtree: true });
            }
        });
    </script>




{% comment %} 
    //script funzionante che invia tutta la riga di dat al server, non solo quelli modificati
    //problema? in nuove istanze di form mi salva tanti record per ogni campo che vado a modificare (essendo il timer istantaneo)   
{% endcomment %}   
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.setAttribute('data-modified', "False");

            field.addEventListener('blur', function () {
                this.setAttribute('data-modified', "True");
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                debounce(() => sendDataToServer(row, formType), delay);
            });
        });
    }

    // Funzione per inviare i dati al server con tutti i campi di un form
    function sendDataToServer(row, formType) {
        let formFields = {};

        // Raccoglie tutti i campi del form (non solo quelli modificati)
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            formFields[field.name] = field.value;
        });

        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: [formFields] })
        })
        .then(response => response.json())
        .then(data => console.log(`Dati ${formType} salvati:`, data))
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];
        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
    

{# script perfettamente funzionante con pasti, in questo script uso la risposta del server per aggiornare l'id del record nel formset #}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                // Invia tutti i dati del formset quando un campo viene modificato
                debounce(() => sendDataToServer(formType), delay);
            });
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
    let formsetData = [];
    
    document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
        let formFields = {};
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            formFields[field.name] = field.value;
        });
        //inserire l'id mi permette di capire se sto modificando un record esistente o sto creando un nuovo record
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formFields[hiddenId.name] = hiddenId.value;
        }

        formsetData.push(formFields);
    });

    const urls = {
        pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
    };

    fetch(urls[formType], {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ data: formsetData })
    })
    .then(response => response.json())
    .then(data => {
        console.log(`Dati ${formType} salvati:`, data);

        // Aggiorna gli ID nel formset in base agli ID restituiti dal server
        data.updated_rows.forEach(updatedRow => {
            const formsetPrefix = updatedRow.formset_prefix;
            const pastoId = updatedRow.pasto_id;
            const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);    //selezioniamo il campo di input nascosto che tiene l'id del record
            if (inputIdField) {
                inputIdField.value = pastoId;
            }
        });
    })
    .catch(error => console.error('Errore:', error));
}


    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>






{% comment %} 
// funziona come precedente+ gestione di tutti i formset , problema, non gestisce le foto da usare con salva_pasti2
{% endcomment %}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>



{% comment %}
ULTIMA VERISONE SCRIPT, TENTATIVO DI GESTIORE IL CARICAMENTO DI FILE #######################################################
{% endcomment %}
{% section %}
    
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;
    const debounceDelayFormset2 = 0;
    const debounceDelayFormset3 = 0;
    const debounceDelayFormset4 = 0;
    const debounceDelayFormset5 = 0;

    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            if (field.type === "file") {
                field.addEventListener('change', function () {
                    sendFileToServer(field, formType, row);
                });
            } else {
                field.addEventListener('blur', function () {
                    const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                                  formType === 'pasti' ? debounceDelayFormset2 :
                                  formType === 'trasporti' ? debounceDelayFormset3 :
                                  formType === 'convegni' ? debounceDelayFormset4 :
                                  debounceDelayFormset5;

                    debounce(() => sendDataToServer(formType), delay);
                });
            }
        });
    }

    function sendFileToServer(field, formType, row) {
        const formData = new FormData();
        const file = field.files[0];
        formData.append(field.name, file);

        // Append additional form data (like hidden ID) for context
        const hiddenId = row.querySelector('input[name$="-id"]');
        if (hiddenId) {
            formData.append(hiddenId.name, hiddenId.value);
        }

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Immagine ${formType} salvata:`, data);

            // Update ID in the formset with the server response if new ID is returned
            if (data.updated_rows) {
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    const newId = updatedRow.new_id;
                    const inputIdField = row.querySelector(`input[name="${formsetPrefix}-id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
        })
        .catch(error => console.error('Errore nel caricamento dell\'immagine:', error));
    }

    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                if (field.type !== "file") {
                    formFields[field.name] = field.value;
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Update ID fields in the formset for any newly created or updated rows
            if (data.updated_rows) {
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    const newId = updatedRow.new_id;
                    const inputIdField = document.querySelector(`input[name="${formsetPrefix}-id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
        })
        .catch(error => console.error('Errore:', error));
    }

    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>

{% endsection %}



{% comment %} 
//suggerimento copilot gestione anche dei file: aggiunta listener per capo file e modifica di Send DataTo Server {% endcomment %}
    <script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        //let formsetData = [];
        let formsetData = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            //let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                
                if (field.type === 'file') { // Aggiungi file al FormData 
                    if (field.files.length > 0) { 
                        formsetData.append(field.name, field.files[0]); 
                    } 
                } else { 
                    formsetData.append(field.name, field.value); 
                }
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                //formFields[hiddenId.name] = hiddenId.value;
                formsetData.append(hiddenId.name, hiddenId.value);
            }

            //formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetData
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
{% comment %}
funziiona la modifica di pasti e l'inserimento di pasti nuovi, ho diviso sendDataToServer in due funzioni, una per le iiagini e una per i dati
non funziona modifica trasoirti (simile a pasti)
funzioina modifica di altrespese|convgni|pernottamenti ma non l'inserimento di nuovo record (da gestire ispirato a spese )
{% endcomment %}

<script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('blur', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer2(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType) {
        let formsetDataIMG = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files.length > 0) { 
                    formsetDataIMG.append(field.name, field.files[0]); 
                } 
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>

{% comment %}
FUNZIONA: alla funzione precedente ho modificato il listener che ora è ==='change' e rimane divisa la funzione sendDataToServer in due funzioni, una per i dati e una per le immagini

PASTI: 
modifica va |inserimento va | immagini vanno | non va il pattumino del widget (perchè?) e non appare l'immagine caricata (icona blu) siccome non si riaggiorna la pagina 
TRASPORTI:

CONVEGNI+ALTRESPESE*PERNOTTAMENTI:
modifica va |inserimento non va | immagini vanno in modifica ma non ininserimento | non va il pattumino del widget (perchè?) e non appare l'immagine caricata (icona blu) siccome non si riaggiorna la pagina

{% endcomment %}

     
<script>
    let debounceTimer;
    const debounceDelayFormset1 = 0;  // Delay per "pernottamenti"
    const debounceDelayFormset2 = 0;  // Delay per "pasti"
    const debounceDelayFormset3 = 0;  // Delay per "trasporti"
    const debounceDelayFormset4 = 0;  // Delay per "convegni"
    const debounceDelayFormset5 = 0;  // Delay per "altrespese"

    // Funzione debounce per evitare troppi invii ravvicinati
    function debounce(callback, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            field.addEventListener('change', function () {
                const delay = formType === 'pernottamenti' ? debounceDelayFormset1 :
                              formType === 'pasti' ? debounceDelayFormset2 :
                              formType === 'trasporti' ? debounceDelayFormset3 :
                              formType === 'convegni' ? debounceDelayFormset4 :
                              debounceDelayFormset5;
                
                debounce(() => sendDataToServer(formType), delay);
            });
        });
        // Aggiungiamo un listener per il caricamento delle immagini 
        row.querySelectorAll('.form-group input[type="file"]').forEach(function (field) { 
            field.addEventListener('change', function () { 
                sendDataToServer2(formType); 
            }); 
        });
    }

    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType) {
        let formsetDataIMG = new FormData();

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files.length > 0) { 
                    formsetDataIMG.append(field.name, field.files[0]); 
                } 
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>


{% comment %}
funziona da dio con i pasti, la risposta ajax deve essere resa compatibile per tutti i form
{% endcomment %}

<script>

    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            // Aggiungi un event listener per l'evento "change"
            field.addEventListener('change', function () {
                if (field.type === 'file') {
                    sendDataToServer2(formType,row);
                } else {
                    sendDataToServer(formType);
                }
            });
        });
    }


    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
            
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType,formRow) {
        let formsetDataIMG = new FormData();
        /*
        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files && field.files.length > 0) {
                    formsetDataIMG.append(field.name, field.files[0]);
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });
        */
         formRow.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
             if (field.files && field.files.length > 0) {
                 formsetDataIMG.append(field.name, field.files[0]);
             }
         });
         const hiddenId = formRow.querySelector('input[name$="-id"]');
         if (hiddenId) {
             formsetDataIMG.append(hiddenId.name, hiddenId.value);
         }


        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const pastoId = updatedRow.pasto_id;
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = pastoId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
//--------------####################------------------//
 
    
<script>
    // Funzione per evitare salvataggi di record vuoti nel caso in cui la data venga inserita parzialmente
    function isValidDate(dateString) {
        // Controlla che il formato sia valido (AAAA-MM-GG)
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(dateString)) {
            return false;
        }
    
        // Prova a creare un oggetto Date
        const date = new Date(dateString);
        const [year, month, day] = dateString.split('-').map(Number);
    
        // Controlla che i valori corrispondano
        return (
            date.getFullYear() === year &&
            date.getMonth() === month - 1 &&
            date.getDate() === day
        );
    }


    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            // Aggiungi un event listener per l'evento "change"
            field.addEventListener('change', function () {
                if(field.type === 'date' || field.name.includes('data')) {
                    if (!isValidDate(field.value)) {
                        return;
                    }
                }
                
                if (field.type === 'file') {
                    sendDataToServer2(formType,row);
                } else {
                    sendDataToServer(formType);
                }
            });
        });
        // listener per l'evento "click" ai bottoni con classe delete-row btn btn-danger 
        row.querySelectorAll('.delete-row.btn.btn-danger').forEach(function(button) {
            button.addEventListener('click', function() { 
                sendDataToServer(formType);
            });
        });
    }


    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
            
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Caso DELETE: aggiorna l'intero formset con i dati di updated_data
            if (data.updated_data) {
                const formsetContainer = document.querySelector(`#${formType}-formset-container`);
                formsetContainer.innerHTML = ""; // Svuota il contenitore dei form
                // formsetContainer.innerHTML = data.updated_formset_html;
                // Ricollega gli event listener alle nuove righe
                //document.querySelectorAll(`.${formType}_formset_row`).forEach(row => monitorFields(row, formType));
            
            
                // Ricrea i form dal JSON di updated_data
                data.updated_data.forEach(form => {
                    const formElement = createFormElement(form); // Funzione che costruisce l'HTML per un form
                    formsetContainer.appendChild(formElement);
                });
            }
            
            if(data.updated_rows){
                // Gestione dinamica di tutti i formset
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    //facessi sempre updateRow.id non avrei bisogno di fare il controllo
                    const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;
    
                    // Aggiorna il valore dell'id corrispondente
                    const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
            
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType,formRow) {
        let formsetDataIMG = new FormData();
        /*
        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files && field.files.length > 0) {
                    formsetDataIMG.append(field.name, field.files[0]);
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });
        */
         formRow.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
             if (field.files && field.files.length > 0) {
                 formsetDataIMG.append(field.name, field.files[0]);
             }
         });
         const hiddenId = formRow.querySelector('input[name$="-id"]');
         if (hiddenId) {
             formsetDataIMG.append(hiddenId.name, hiddenId.value);
         }


        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Gestione dinamica di tutti i formset
            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;

                // Aggiorna il valore dell'id corrispondente
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = newId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>
##############################################################################################################
//qui c'è l'ultima versione di misisoni.html prima che inserissi le modifiche per il primo form mai implementato. 
//lo script che gestisce i formset è quello di ultima versione ed è quello sopra

 {% extends "Rimborsi/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Missione{% endblock %}
{% block h1title %}Modifica Missione
    <a class="btn btn-primary" href="{% url 'RimborsiApp:resoconto' missione.id %}" role="button">Resoconto</a>
{% endblock %}


{% block content %}
    {#    {% spaceless %}#}
    {% if user.is_authenticated %}
        {% crispy missione_form %}

        {% load form_tags %}
        <h3>Pasti:</h3>
        <form action="{% url 'RimborsiApp:salva_pasti' id=missione.id %}" method="post" enctype="multipart/form-data"> 
            {% csrf_token %}
            {{ pasti_formset.management_form }}
            <div id="pasti-formset-container">
                {% for form in pasti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 pasti_formset_row dynamic-formset1 text-black d-lg-flex align-items-end"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        {% for field in form.visible_fields %}
                            <div class="form-group mx-1 ">
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {% if field.name == 'img_scontrino1' or field.name == 'img_scontrino2' or field.name == 'img_scontrino3' %}
                                    {{ field }}
                                {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }} 
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </form>
         <hr>

        
        {% load form_tags %}    {# added modified-data on html template #}

        <h3>Pernottamenti:</h3>
        <form action="{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ pernottamenti_formset.management_form }}
            <div id="pernottamenti-formset-container">
                {% for form in pernottamenti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 pernottamenti_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                        <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                        {{ field.errors.as_ul }}
                                        {{ field|add_data_modified:"False" }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

        <hr>
        <h3><a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Trasporti"
               data-content="Se una tratta non ha spese, ma deve ricevere un'indennità chilometrica, inserirla popolando il campo spesa a
            0. Per le tratte che non devono ricevere un'indennità chilometrica lasciare il campo km vuoto."><i
            class="fa fa-info-circle fa-1x" aria-hidden="true"></i></a> Trasporti:
        </h3>
        <form action="{% url 'RimborsiApp:salva_trasporti'  id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ trasporti_formset.management_form }}
            <div id="trasporti-formset-container">
                {% for form in trasporti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 trasporti_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                        <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                        {{ field.errors.as_ul }}
                                        {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>


        <hr>
        <h3>Iscrizione Convegni:</h3>
        <form action="{% url 'RimborsiApp:salva_convegni' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ convegni_formset.management_form }}
            <div id="convegni-formset-container">
                {% for form in convegni_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 convegni_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

        <hr>
        <h3>Altre Spese:</h3>
        <form action="{% url 'RimborsiApp:salva_altrespese' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ altrespese_formset.management_form }}
            <div id="altrespese-formset-container">
                {% for form in altrespese_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 altrespese_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

    {% endif %}
    
   
 
    <script>
    // Funzione per evitare salvataggi di record vuoti nel caso in cui la data venga inserita parzialmente
    function isValidDate(dateString) {
        // Controlla che il formato sia valido (AAAA-MM-GG)
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(dateString)) {
            return false;
        }
    
        // Prova a creare un oggetto Date
        const date = new Date(dateString);
        const [year, month, day] = dateString.split('-').map(Number);
    
        // Controlla che i valori corrispondano
        return (
            date.getFullYear() === year &&
            date.getMonth() === month - 1 &&
            date.getDate() === day
        );
    }


    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            // Aggiungi un event listener per l'evento "change"
            field.addEventListener('change', function () {
                if(field.type === 'date' || field.name.includes('data')) {
                    if (!isValidDate(field.value)) {
                        return;
                    }
                }
                
                if (field.type === 'file') {
                    sendDataToServer2(formType,row);
                } else {
                    sendDataToServer(formType);
                }
            });
        });
        // listener per l'evento "click" ai bottoni con classe delete-row btn btn-danger 
        row.querySelectorAll('.delete-row.btn.btn-danger').forEach(function(button) {
            button.addEventListener('click', function() { 
                sendDataToServer(formType);
            });
        });
    }


    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
            
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Caso DELETE: aggiorna l'intero formset con i dati di updated_data
            if (data.updated_data) {
                const formsetContainer = document.querySelector(`#${formType}-formset-container`);
                formsetContainer.innerHTML = ""; // Svuota il contenitore dei form
                // formsetContainer.innerHTML = data.updated_formset_html;
                // Ricollega gli event listener alle nuove righe
                //document.querySelectorAll(`.${formType}_formset_row`).forEach(row => monitorFields(row, formType));
            
            
                // Ricrea i form dal JSON di updated_data
                data.updated_data.forEach(form => {
                    const formElement = createFormElement(form); // Funzione che costruisce l'HTML per un form
                    formsetContainer.appendChild(formElement);
                });
            }
            
            if(data.updated_rows){
                // Gestione dinamica di tutti i formset
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    //facessi sempre updateRow.id non avrei bisogno di fare il controllo
                    const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;
    
                    // Aggiorna il valore dell'id corrispondente
                    const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
            
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType,formRow) {
        let formsetDataIMG = new FormData();
        /*
        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files && field.files.length > 0) {
                    formsetDataIMG.append(field.name, field.files[0]);
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });
        */
         formRow.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
             if (field.files && field.files.length > 0) {
                 formsetDataIMG.append(field.name, field.files[0]);
             }
         });
         const hiddenId = formRow.querySelector('input[name$="-id"]');
         if (hiddenId) {
             formsetDataIMG.append(hiddenId.name, hiddenId.value);
         }


        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Gestione dinamica di tutti i formset
            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;

                // Aggiorna il valore dell'id corrispondente
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = newId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>



    <script src="{% static 'RimborsiApp/formset/jquery_formset.js' %}"></script>
    <script type="text/javascript">
        $('.pasti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'pasti_set',
            ifdelete: false,
            formCssClass: 'dynamic-formset1',
        });
        $('.pernottamenti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'pernottamenti',
            formCssClass: 'dynamic-formset2',
        });
        $('.trasporti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'trasporto_set',
            formCssClass: 'dynamic-formset3',
        });

        $('.convegni_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'convegni',
            formCssClass: 'dynamic-formset4',
        });

        $('.altrespese_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'altrespese',
            formCssClass: 'dynamic-formset5',
        });

        $(document).ready(function () {
            $('#form_scontrino').submit(function () {
                $("#form_scontrino :disabled").removeAttr('disabled');
            });

            let mezzi = $('#id_mezzi_previsti_1');
            let mezzi_altrui = $('#id_mezzi_previsti_2');
            if (!mezzi.is(":checked")) {
                $('#div_id_automobile').hide();
                $('#div_id_motivazione_automobile').hide();
            }
            if (!mezzi_altrui.is(":checked")) {
                $('#div_id_automobile_altrui').hide();
            }


            let toggle_mezzi = function () {
                $('#div_id_automobile').toggle();
                $('#div_id_motivazione_automobile').toggle();
            };
            let toggle_mezzi_altrui = function () {
                $('#div_id_automobile_altrui').toggle();
            };
            mezzi.click(function () {
                if (mezzi_altrui.is(":checked")) {
                    toggle_mezzi_altrui();
                    mezzi_altrui.prop('checked', false);
                }
                toggle_mezzi();
            });
            mezzi_altrui.click(function () {
                if (mezzi.is(":checked")) {
                    toggle_mezzi();
                    mezzi.prop('checked', false);
                }
                toggle_mezzi_altrui();
            });

        });

        $('.popover-dismiss').popover({
            trigger: 'focus'
        });
    </script>

    {#    {% endspaceless %}#}
{% endblock %}

// #-----------ultima versione misisoni
 {% extends "Rimborsi/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Missione{% endblock %}
{% block h1title %}Modifica Missione
    <a class="btn btn-primary" href="{% url 'RimborsiApp:resoconto' missione.id %}" role="button">Resoconto</a>
{% endblock %}


{% block content %}
    {#    {% spaceless %}#}
    {% if user.is_authenticated %}
        {% comment %}
        <form id="missione-form">
            {% csrf_token %}
        </form>
        {% endcomment %}
        
        {% crispy missione_form %}

        <script>
            function validateMissionDates(formData) {
                const inizio = new Date(formData['inizio']);
                const fine = new Date(formData['fine']);
                const inizioOra = formData['inizio_ora'];
                const fineOra = formData['fine_ora'];
            
                if (fine < inizio) {
                    alert("La data di inizio deve essere antecedente a quella di fine.");
                    field.focus();
                    return false;
                }
            
                if (inizio.getTime() === fine.getTime() && fineOra < inizioOra) {
                    alert("L'ora di inizio deve essere antecedente a quella di fine.");
                    return false;
                }
            
                return true;
            }
            
                    
                    
                        // Funzione per inviare dati AJAX specifici per il form missione
            function sendMissionDataToServer(formData) {
                const url = "{% url 'RimborsiApp:missione' id=missione.id %}";
            
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify(formData),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Dati missione salvati:', data);
                        // Puoi aggiungere logica per aggiornare dinamicamente l'interfaccia
                    })
                    .catch(error => console.error('Errore durante il salvataggio della missione:', error));
            }
            
            // Funzione per validare i campi obbligatori del form
            function validateMissionForm(formData) {
                const requiredFields = [
                    'citta_destinazione',
                    'stato_destinazione',
                    'inizio',
                    'inizio_ora',
                    'fine',
                    'fine_ora',
                    'fondo',
                    'motivazione',
                    'struttura_fondi'
                ];
            
                let missingFields = [];
            
                requiredFields.forEach(field => {
                    if (!formData[field] || formData[field].trim() === '') {
                        missingFields.push(field);
                    }
                });
            
                if (missingFields.length > 0) {
                    alert(`I campi contrassegnati da "*" sono obbligatori e devono essere compilati! \nCampo mancante: ${missingFields.join(', ')}`);
                    return false;
                }
                // validazione delle date e ore
                if (!validateMissionDates(formData)) {
                    return false;
                }
            
                return true;
            }
            //---//
            // Funzione per monitorare i campi del form missione
            function monitorMissionForm() {
                const missionForm = document.querySelector('#missione-form'); // ID unico aggiunto al form
                if (!missionForm) return;
            
                missionForm.querySelectorAll('input, select, textarea').forEach(field => {
                    field.addEventListener('change', function () {
                        const formData = {};
                        missionForm.querySelectorAll('input, select, textarea').forEach(input => {
                            if(input.type === 'checkbox') {
                                if(!formData[input.name]) {
                                    formData[input.name] = [];
                                }
                                if(input.checked){
                                    formData[input.name].push(input.value);
                                }
                            } else {
                                formData[input.name] = input.value;
                            }
                        });
            
                        // Validazione dei campi prima di inviare
                        if (validateMissionForm(formData)) {
                            sendMissionDataToServer(formData);
                        }
                    });
                });
            }
            
            // Esegui il monitoraggio dopo il caricamento della pagina
            document.addEventListener('DOMContentLoaded', function () {
                monitorMissionForm();
            });

        </script>

        {% load form_tags %}
        <h3>Pasti:</h3>
        <form action="{% url 'RimborsiApp:salva_pasti' id=missione.id %}" method="post" enctype="multipart/form-data"> 
            {% csrf_token %}
            {{ pasti_formset.management_form }}
            <div id="pasti-formset-container">
                {% for form in pasti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 pasti_formset_row dynamic-formset1 text-black d-lg-flex align-items-end"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        {% for field in form.visible_fields %}
                            <div class="form-group mx-1 ">
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {% if field.name == 'img_scontrino1' or field.name == 'img_scontrino2' or field.name == 'img_scontrino3' %}
                                    {{ field }}
                                {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }} 
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </form>
         <hr>

        
        {% load form_tags %}    {# added modified-data on html template #}

        <h3>Pernottamenti:</h3>
        <form action="{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ pernottamenti_formset.management_form }}
            <div id="pernottamenti-formset-container">
                {% for form in pernottamenti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 pernottamenti_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                        <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                        {{ field.errors.as_ul }}
                                        {{ field|add_data_modified:"False" }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

        <hr>
        <h3><a tabindex="0" class="popover-dismiss" role="button" data-toggle="popover"
               data-trigger="focus" title="Trasporti"
               data-content="Se una tratta non ha spese, ma deve ricevere un'indennità chilometrica, inserirla popolando il campo spesa a
            0. Per le tratte che non devono ricevere un'indennità chilometrica lasciare il campo km vuoto."><i
            class="fa fa-info-circle fa-1x" aria-hidden="true"></i></a> Trasporti:
        </h3>
        <form action="{% url 'RimborsiApp:salva_trasporti'  id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ trasporti_formset.management_form }}
            <div id="trasporti-formset-container">
                {% for form in trasporti_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 trasporti_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                        <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                        {{ field.errors.as_ul }}
                                        {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>


        <hr>
        <h3>Iscrizione Convegni:</h3>
        <form action="{% url 'RimborsiApp:salva_convegni' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ convegni_formset.management_form }}
            <div id="convegni-formset-container">
                {% for form in convegni_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 convegni_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

        <hr>
        <h3>Altre Spese:</h3>
        <form action="{% url 'RimborsiApp:salva_altrespese' id=missione.id %}" method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ altrespese_formset.management_form }}
            <div id="altrespese-formset-container">
                {% for form in altrespese_formset.forms %}
                    <div class="card-lg-inline mb-5 mb-md-3 altrespese_formset_row text-black"
                         style="background-color: whitesmoke; padding: 15px; border: 1px solid #ccc;">
                        <div class="card-body d-lg-flex">
                            {% for field in form.visible_fields %}
                                <div class="form-group mx-1 flex-grow-1">
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {% if field.name == 'img_scontrino' %}
                                        {{ field }}
                                    {% else %}
                                    <label for="{{ field.id_for_label }}">{{ field.label|capfirst }}</label>
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            
        </form>

    {% endif %}
    
   
 {% comment %}
 {% endcomment %}
    
<script>

    // Funzione per evitare salvataggi di record vuoti nel caso in cui la data venga inserita parzialmente
    function isValidDate(dateString) {
        // Controlla che il formato sia valido (AAAA-MM-GG)
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(dateString)) {
            return false;
        }
    
        // Prova a creare un oggetto Date
        const date = new Date(dateString);
        const [year, month, day] = dateString.split('-').map(Number);
    
        // Controlla che i valori corrispondano
        return (
            date.getFullYear() === year &&
            date.getMonth() === month - 1 &&
            date.getDate() === day
        );
    }


    // Funzione per monitorare i campi di un formset e inviare dati al server
    function monitorFields(row, formType) {
        row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
            // Aggiungi un event listener per l'evento "change"
            field.addEventListener('change', function () {
                if(field.type === 'date' || field.name.includes('data')) {
                    if (!isValidDate(field.value)) {
                        return;
                    }
                }
                
                if (field.type === 'file') {
                    sendDataToServer2(formType,row);
                } else {
                    sendDataToServer(formType);
                }
            });
        });
        // listener per l'evento "click" ai bottoni con classe delete-row btn btn-danger 
        row.querySelectorAll('.delete-row.btn.btn-danger').forEach(function(button) {
            button.addEventListener('click', function() {                          //ho aggiunto event
                //event.preventDefault();                                                 // Evita l'azione predefinita, aggiunto

                sendDataToServer(formType);
            });
        });
    }


    // Funzione per inviare tutti i dati del formset al server
    function sendDataToServer(formType) {
        let formsetData = [];

        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                formFields[field.name] = field.value;
            });
            
            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formFields[hiddenId.name] = hiddenId.value;
                
            }

            formsetData.push(formFields);
        });

        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ data: formsetData })
        })
        .then(response => response.json())
            
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Caso DELETE: aggiorna l'intero formset con i dati di updated_data
            if (data.deleted_rows) {
                /*
                data.deleted_rows.forEach(deletedRow => {
                    const rowId = deletedRow.id; // ID del record eliminato
                    const formsetPrefix = deletedRow.formset_prefix;
                    
                    // Trova e rimuovi il record corrispondente
                    const rowElement = document.querySelector(`input[name="${formsetPrefix}id"][value="${rowId}"]`);
                    if (rowElement) {
                        const rowToDelete = rowElement.closest(`.${formType}_formset_row`);
                        if (rowToDelete) {
                            rowToDelete.remove(); // Rimuove il nodo dal DOM
                        }
                    }
                    */
                    //const urlReload = `/missione/update/${missioneId}/?altrespese_formset_deleted=true`;
                const urlReload = `/missione/5`;
                fetch(urlReload, { method: 'GET' })
                .then(() => {
                    window.location.reload(); // Ricarica la pagina interamente
                })
                .catch(error => console.error('Errore durante il caricamento:', error));

            }

            
            if(data.updated_rows){
                // Gestione dinamica di tutti i formset
                data.updated_rows.forEach(updatedRow => {
                    const formsetPrefix = updatedRow.formset_prefix;
                    //facessi sempre updateRow.id non avrei bisogno di fare il controllo
                    const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;
    
                    // Aggiorna il valore dell'id corrispondente
                    const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                    if (inputIdField) {
                        inputIdField.value = newId;
                    }
                });
            }
            
        })
        .catch(error => console.error('Errore:', error));
    }
    //IMG ONLY
     function sendDataToServer2(formType,formRow) {
        let formsetDataIMG = new FormData();
        /*
        document.querySelectorAll(`.${formType}_formset_row`).forEach(row => {
            let formFields = {};
            row.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
                //formFields[field.name] = field.value;
                if (field.files && field.files.length > 0) {
                    formsetDataIMG.append(field.name, field.files[0]);
                }
            });

            const hiddenId = row.querySelector('input[name$="-id"]');
            if (hiddenId) {
                formsetDataIMG.append(hiddenId.name, hiddenId.value);
            }

        });
        */
         formRow.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(function (field) {
             if (field.files && field.files.length > 0) {
                 formsetDataIMG.append(field.name, field.files[0]);
             }
         });
         const hiddenId = formRow.querySelector('input[name$="-id"]');
         if (hiddenId) {
             formsetDataIMG.append(hiddenId.name, hiddenId.value);
         }


        const urls = {
            pernottamenti: "{% url 'RimborsiApp:salva_pernottamenti' id=missione.id %}",
            pasti: "{% url 'RimborsiApp:salva_pasti' id=missione.id %}",
            trasporti: "{% url 'RimborsiApp:salva_trasporti' id=missione.id %}",
            convegni: "{% url 'RimborsiApp:salva_convegni' id=missione.id %}",
            altrespese: "{% url 'RimborsiApp:salva_altrespese' id=missione.id %}"
        };

        fetch(urls[formType], {
            method: 'POST',
            headers: {
                //'Content-Type': 'application/json',       //non serve più: Quando si utilizza FormData, non si deve specificare il Content-Type come application/json perché FormData gestisce automaticamente il tipo di contenuto.
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            //body: JSON.stringify({ data: formsetData })
            body: formsetDataIMG
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Dati ${formType} salvati:`, data);

            // Gestione dinamica di tutti i formset
            data.updated_rows.forEach(updatedRow => {
                const formsetPrefix = updatedRow.formset_prefix;
                const newId = updatedRow.pasto_id || updatedRow.trasporto_id || updatedRow.altro_id || updatedRow.pernottamento_id || updatedRow.convegno_id;

                // Aggiorna il valore dell'id corrispondente
                const inputIdField = document.querySelector(`input[name="${formsetPrefix}id"]`);
                if (inputIdField) {
                    inputIdField.value = newId;
                }
            });
        })
        .catch(error => console.error('Errore:', error));
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        const formsets = ['pernottamenti', 'pasti', 'trasporti', 'convegni', 'altrespese'];

        formsets.forEach(formset => {
            document.querySelectorAll(`.${formset}_formset_row`).forEach(row => monitorFields(row, formset));
        });

        const containers = {
            pernottamenti: document.getElementById('pernottamenti-formset-container'),
            pasti: document.getElementById('pasti-formset-container'),
            trasporti: document.getElementById('trasporti-formset-container'),
            convegni: document.getElementById('convegni-formset-container'),
            altrespese: document.getElementById('altrespese-formset-container')
        };

        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(newNode => {
                    formsets.forEach(formset => {
                        if (newNode.classList && newNode.classList.contains(`${formset}_formset_row`)) {
                            monitorFields(newNode, formset);
                        }
                    });
                });
            });
        });

        Object.values(containers).forEach(container => {
            if (container) observer.observe(container, { childList: true, subtree: true });
        });
    });
</script>



    <script src="{% static 'RimborsiApp/formset/jquery_formset.js' %}"></script>
    <script type="text/javascript">
        $('.pasti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'pasti_set',
            ifdelete: false,
            formCssClass: 'dynamic-formset1',
        });
        $('.pernottamenti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'pernottamenti',
            formCssClass: 'dynamic-formset2',
        });
        $('.trasporti_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'trasporto_set',
            formCssClass: 'dynamic-formset3',
        });

        $('.convegni_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'convegni',
            formCssClass: 'dynamic-formset4',
        });

        $('.altrespese_formset_row').formset({
            addText: 'Aggiungi',
            deleteText: 'Elimina',
            prefix: 'altrespese',
            formCssClass: 'dynamic-formset5',
        });

        $(document).ready(function () {
            $('#form_scontrino').submit(function () {
                $("#form_scontrino :disabled").removeAttr('disabled');
            });

            let mezzi = $('#id_mezzi_previsti_1');
            let mezzi_altrui = $('#id_mezzi_previsti_2');
            if (!mezzi.is(":checked")) {
                $('#div_id_automobile').hide();
                $('#div_id_motivazione_automobile').hide();
            }
            if (!mezzi_altrui.is(":checked")) {
                $('#div_id_automobile_altrui').hide();
            }


            let toggle_mezzi = function () {
                $('#div_id_automobile').toggle();
                $('#div_id_motivazione_automobile').toggle();
            };
            let toggle_mezzi_altrui = function () {
                $('#div_id_automobile_altrui').toggle();
            };
            mezzi.click(function () {
                if (mezzi_altrui.is(":checked")) {
                    toggle_mezzi_altrui();
                    mezzi_altrui.prop('checked', false);
                }
                toggle_mezzi();
            });
            mezzi_altrui.click(function () {
                if (mezzi.is(":checked")) {
                    toggle_mezzi();
                    mezzi.prop('checked', false);
                }
                toggle_mezzi_altrui();
            });

        });

        $('.popover-dismiss').popover({
            trigger: 'focus'
        });
    </script>

    {#    {% endspaceless %}#}
{% endblock %}

